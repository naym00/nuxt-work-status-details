<template>
  <v-container style="background-color: #E6E4E4; height:550px" >
    <div>
      <AddNewTask :projects="projects" :projectImportance="projectImportance" :developersJson="developersJson" :stagesJson="stagesJson" @addNewTask="addNewTask($event)"></AddNewTask>
      <AddNewProject @newproject="newProjectDetails($event)"></AddNewProject>
      <div style="width: 500px;"><v-select v-model="projectsToFilter" :items="projects" item-text="title" label="Filter By Projects" clearable multiple chips persistent-hint></v-select></div>
      

    </div>
    <div class="d-flex flex-row flex-wrap justify-space-around" style="height:100%">

      <div class="d-flex flex-column">
        <div class="d-flex flex-row align-center">
          <v-chip small style="width:90%;height: 50px;" color="light-green lighten-5 my-2">
            Stage-1
            <v-avatar right class="green darken-2">{{tasks.stage1.length}}</v-avatar>
          </v-chip>
        </div>

        <draggable class="div-container" :list="tasks.stage1" group="tasks" @change="log($event, 1)">
          <SingleTask v-for="(task, index) in tasks.stage1" :key="index" :item="task" @deleteTask="deleteTask($event)" :stage="'stage1'" @updateData="updateData($event)"></SingleTask>
        </draggable>
      </div>

      <div class="d-flex flex-column">
        <div class="d-flex flex-row align-center">
          <v-chip small style="width:90%;height: 50px;" color="light-green lighten-5 my-2">
            Stage-2
            <v-avatar right class="green darken-2">{{tasks.stage2.length}}</v-avatar>
          </v-chip>
        </div>

        <draggable class="div-container" :list="tasks.stage2" group="tasks" @change="log($event, 2)">
          <SingleTask v-for="(task, index) in tasks.stage2" :key="index" :item="task" @deleteTask="deleteTask($event)" :stage="'stage2'" @updateData="updateData($event)"></SingleTask>
        </draggable>
      </div>

      <div class="d-flex flex-column">
        <div class="d-flex flex-row align-center">
          <v-chip small style="width:90%;height: 50px;" color="light-green lighten-5 my-2">
            Stage-3
            <v-avatar right class="green darken-2">{{tasks.stage3.length}}</v-avatar>
          </v-chip>
        </div>

        <draggable class="div-container" :list="tasks.stage3" group="tasks" @change="log($event, 3)">
          <SingleTask v-for="(task, index) in tasks.stage3" :key="index" :item="task" @deleteTask="deleteTask($event)" :stage="'stage3'" @updateData="updateData($event)"></SingleTask>
        </draggable>
      </div>

      <div class="d-flex flex-column">
        <div class="d-flex flex-row align-center">
          <v-chip small style="width:90%;height: 50px;" color="light-green lighten-5 my-2">
            Stage-4
            <v-avatar right class="green darken-2">{{tasks.stage4.length}}</v-avatar>
          </v-chip>
        </div>

        <draggable class="div-container" :list="tasks.stage4" group="tasks" @change="log($event, 4)">
          <SingleTask v-for="(task, index) in tasks.stage4" :key="index" :item="task" @deleteTask="deleteTask($event)" :stage="'stage4'" @updateData="updateData($event)"></SingleTask>
        </draggable>
      </div>
    
    </div>
    
  </v-container>

  <!-- <v-container style="background-color: #E6E4E4; height:550px" >
    <div>
      <AddNewTask :projects="projects" :projectImportance="projectImportance" :developersJson="developersJson" :stagesJson="stagesJson" @addNewTask="addNewTask($event)"></AddNewTask>
      <AddNewProject @newproject="newProjectDetails($event)"></AddNewProject>
      <div style="width: 500px;"><v-select v-model="projectsToFilter" :items="projects" item-text="title" label="Filter By Projects" clearable multiple chips persistent-hint></v-select></div>
      

    </div>
    <div class="d-flex flex-row flex-wrap justify-space-around" style="height:100%">

      <div class="d-flex flex-column">
        <div class="d-flex flex-row align-center">
          <v-chip small style="width:90%;height: 50px;" color="light-green lighten-5 my-2">
            Stage-1
            <v-avatar right class="green darken-2">{{copyTask.stage1.length}}</v-avatar>
          </v-chip>
        </div>

        <draggable class="div-container" :list="copyTask.stage1" group="tasks" @change="log($event, 1)">
          <SingleTask v-for="(task, index) in copyTask.stage1" :key="index" :item="task" @deleteTask="deleteTask($event)" :stage="'stage1'" @updateData="updateData($event)"></SingleTask>
        </draggable>
      </div>

      <div class="d-flex flex-column">
        <div class="d-flex flex-row align-center">
          <v-chip small style="width:90%;height: 50px;" color="light-green lighten-5 my-2">
            Stage-2
            <v-avatar right class="green darken-2">{{copyTask.stage2.length}}</v-avatar>
          </v-chip>
        </div>

        <draggable class="div-container" :list="copyTask.stage2" group="tasks" @change="log($event, 2)">
          <SingleTask v-for="(task, index) in copyTask.stage2" :key="index" :item="task" @deleteTask="deleteTask($event)" :stage="'stage2'" @updateData="updateData($event)"></SingleTask>
        </draggable>
      </div>

      <div class="d-flex flex-column">
        <div class="d-flex flex-row align-center">
          <v-chip small style="width:90%;height: 50px;" color="light-green lighten-5 my-2">
            Stage-3
            <v-avatar right class="green darken-2">{{copyTask.stage3.length}}</v-avatar>
          </v-chip>
        </div>

        <draggable class="div-container" :list="copyTask.stage3" group="tasks" @change="log($event, 3)">
          <SingleTask v-for="(task, index) in copyTask.stage3" :key="index" :item="task" @deleteTask="deleteTask($event)" :stage="'stage3'" @updateData="updateData($event)"></SingleTask>
        </draggable>
      </div>

      <div class="d-flex flex-column">
        <div class="d-flex flex-row align-center">
          <v-chip small style="width:90%;height: 50px;" color="light-green lighten-5 my-2">
            Stage-4
            <v-avatar right class="green darken-2">{{copyTask.stage4.length}}</v-avatar>
          </v-chip>
        </div>

        <draggable class="div-container" :list="copyTask.stage4" group="tasks" @change="log($event, 4)">
          <SingleTask v-for="(task, index) in copyTask.stage4" :key="index" :item="task" @deleteTask="deleteTask($event)" :stage="'stage4'" @updateData="updateData($event)"></SingleTask>
        </draggable>
      </div>
    
    </div>
    
  </v-container> -->
</template>

<script>
import projectsJson from '~/static/json/projects.json'
import taskJson from '~/static/json/task.json'
import importanceLevel from '~/static/json/importanceLevel.json'
import developersJson from '~/static/json/developersJson.json'
import stagesJson from '~/static/json/stagesJson.json'
import draggable from "vuedraggable";
import moment from "moment"
export default {
  name: 'IndexPage',
  components: { draggable },
  data(){
    return {
      projects: JSON.parse(JSON.stringify(projectsJson)).data,
      projectsId: JSON.parse(JSON.stringify(projectsJson)).nextId,
      projectImportance: JSON.parse(JSON.stringify(importanceLevel)).data,
      developersJson: JSON.parse(JSON.stringify(developersJson)).data,
      stagesJson: JSON.parse(JSON.stringify(stagesJson)).data,

      tasks: JSON.parse(JSON.stringify(taskJson)).data,
      // copyTask: JSON.parse(JSON.stringify(taskJson)).data,
      lastId: JSON.parse(JSON.stringify(taskJson)).lastId,

      stateChanged: [],
      // stage: '',
      projectsToFilter: [],
    }
  },
  watch:{
    stateChanged: function(){
      if(this.stateChanged.length == 2){
        if(this.stateChanged[0]["added"] !== undefined){
          let temOb = this.stateChanged[0].added.element
          temOb.stage = `Stage-${this.stateChanged[0].stage}`
          temOb.stateChanged[`Stage${this.stateChanged[0].stage}`] += 1
          let rightNow = moment().format('YYYY-MM-D h:mm:ss A')
          temOb.stateChangeDetails.totalTime += this.calculateDurationInSecond(rightNow, temOb.stateChangeDetails.time)
          temOb.stateChangeDetails.hmnReadFormat = this.convertToDuration(temOb.stateChangeDetails.totalTime)
          temOb.stateChangeDetails.info.push({developer: temOb.assignedTo, switch: `Stage-${this.stateChanged[1].stage} -Stage- ${this.stateChanged[0].stage}`, duration: this.convertToDuration(this.calculateDurationInSecond(rightNow, temOb.stateChangeDetails.time))})
          temOb.stateChangeDetails.time = rightNow
        }
        this.stateChanged = []
        // this.copyTask = {...this.tasks}
      }
    },
    projectsToFilter: function(){
      if(this.projectsToFilter.length == 0){
        this.projects = JSON.parse(JSON.stringify(projectsJson)).data
      }
      else{
        let stage1 = this.tasks.stage1.filter(task => {
          this.projectsToFilter.filter(project => {
            if(task.project.title == project ){
              return task
            }
          })
          
        })
        let stage2 = this.tasks.stage2.filter(task => {
          this.projectsToFilter.filter(project => {
            if(task.project.title == project ){
              return task
            }
          })
          
        })
        let stage3 = this.tasks.stage3.filter(task => {
          this.projectsToFilter.filter(project => {
            if(task.project.title == project ){
              return task
            }
          })
          
        })
        let stage4 = this.tasks.stage4.filter(task => {
          this.projectsToFilter.filter(project => {
            if(task.project.title == project ){
              return task
            }
          })
          
        })
        this.tasks = {
          stage1: stage1,
          stage2: stage2,
          stage3: stage3,
          stage4: stage4
        }
      }
    }
  },
  methods:{
    deleteTask(item){
      let key = ""
      if(item.stage == "Stage-1") key = "stage1"
      else if(item.stage == "Stage-2") key = "stage2"
      else if(item.stage == "Stage-3") key = "stage3"
      else key = "stage4"
      let afterDelete = this.tasks[key].filter(task => task.id != item.id)
      this.tasks[key] = afterDelete

      // this.copyTask = {...this.tasks}
    },
    updateData(data){
      console.log('data data ', data)
      let rightNow = moment().format('YYYY-MM-D h:mm:ss A')
      
      let selectedImportance = {}
      if(data.importanceId != null){
        this.projectImportance.forEach(importance => {
          if(importance.id == data.importanceId) selectedImportance = importance
        })

      }
      this.tasks[data.stage].forEach(task => {
        if(task.id == data.id){
          if(data.title != task.title) task.title = data.title
          if(data.description != task.title) data.description = task.title

          if(Object.keys(selectedImportance).length) if(selectedImportance.level != task.importance.level) task.importance = selectedImportance

          if(data.developer != null){

            if(data.developer != task.assignedTo){
              task.updatedAt = rightNow
              task.uddateDetails[task.uddateDetails.length - 1].endTime = rightNow
              let durationInSeconds= this.calculateDurationInSecond(rightNow, task.uddateDetails[task.uddateDetails.length - 1].startTime)
              task.uddateDetails[task.uddateDetails.length - 1].duration = this.convertToDuration(durationInSeconds)
              task.uddateDetails.push({ developer: data.developer, startTime: rightNow, endTime: "", duration: "" })
              task.assignedTo = data.developer
            }
          }
          if(data.hour != null || data.minute != null){
            let seconds = 0
            if(data.hour != null) seconds += data.hour*60*60
            if(data.minute != null) seconds += data.minute*60
            if(task.stateChangeDetails.info.length){
              let inSeconds = this.convertStringDurationToSeconds(task.stateChangeDetails.info[task.stateChangeDetails.info.length-1].duration)
              task.stateChangeDetails.totalTime -= inSeconds
              task.stateChangeDetails.totalTime += seconds
              task.stateChangeDetails.hmnReadFormat = this.convertToDuration(task.stateChangeDetails.totalTime)
              task.stateChangeDetails.info[task.stateChangeDetails.info.length-1].duration = this.convertToDuration(seconds)
              task.stateChangeDetails.time = rightNow
            }
          }
        }
      })
      // this.copyTask = {...this.tasks}
    },
    addNewTask(task){

      let rightNow = moment().format('YYYY-MM-D h:mm:ss A')
      let selectedProject = {}
      this.projects.forEach(project => {
        if(project.id == task.projectId) selectedProject = project
      })

      let selectedImportance = {}
      this.projectImportance.forEach(importance => {
        if(importance.id == task.importanceId) selectedImportance = importance
      })
    
      let newTask = {
                        id: `${this.lastId}`,
                        title: `${task.title}`,
                        description: `${task.description}`,
                        createdAt: `${rightNow}`,
                        updatedAt: `${rightNow}`,
                        project: selectedProject,
                        importance: selectedImportance,
                        uddateDetails: [
                          { developer: `${task.developer}`, startTime: `${rightNow}`, endTime: "", duration: "" }
                        ],
                        deadline: `${task.date} 11:59:59 PM`,
                        deadlineDetails: [],
                        stage: `${task.stage}`,
                        stateChanged: { Stage1: task.stage == 'Stage-1' ? 1 : 0, Stage2: task.stage == 'Stage-2' ? 1 : 0, Stage3: task.stage == 'Stage-3' ? 1 : 0, Stage4: task.stage == 'Stage-4' ? 1 : 0 },
                        stateChangeDetails: {time: `${rightNow}`, totalTime: 0, hmnReadFormat: "", info: []},
                        assignedTo: `${task.developer}`
                      }
      this.lastId += 1
      if(task.stage == 'Stage-1') { this.tasks.stage1.push(newTask)}
      else if(task.stage == 'Stage-2') { this.tasks.stage2.push(newTask)}
      else if(task.stage == 'Stage-3') { this.tasks.stage3.push(newTask)}
      else if(task.stage == 'Stage-4') { this.tasks.stage4.push(newTask)}

      // this.copyTask = {...this.tasks}
    },
    newProjectDetails(newProject){
      this.projects.push({...newProject, ...{id: this.projectsId}})
      this.projectsId += 1
    },
    // findObject(object, key, toCompare){
    //   let selectedobject = {}
    //   object.forEach(item => {
    //     if(item[key] == toCompare) selectedobject = item
    //   })
    //   return selectedobject
    // },
    convertToDuration(totalSeconds){
        let duration = ''


        // let time = [60, 60, 24, 365]
        // let timeStr = ['munites', 'hours', 'days', 'years']


        
        // time.forEach(() => {
        //   let multiplyValue = time.reduce( (a, b) => a * b )
        //   if(multiplyValue >= totalSeconds){
        //     let dividedValue = parseInt(totalSeconds/multiplyValue)
        //     duration += `${dividedValue} ${timeStr[timeStr.length - 1]} `
        //     totalSeconds = totalSeconds - dividedValue*multiplyValue
        //     time.pop()
        //     timeStr.pop()
        //   }
        //   else{
        //     time.pop()
        //     timeStr.pop()
        //   }
        // })
        // duration += `${totalSeconds} seconds`


        if(totalSeconds>=(365*24*60*60)){
            let year = parseInt(totalSeconds/(365*24*60*60))
            totalSeconds = totalSeconds - year*(365*24*60*60)
            duration += `${year} years `
        }
        if(totalSeconds>=(24*60*60)){
            let day = parseInt(totalSeconds/(24*60*60))
            totalSeconds = totalSeconds - day*(24*60*60)
            duration += `${day} days `
        }
        if(totalSeconds>=(60*60)){
            let hour = parseInt(totalSeconds/(60*60))
            totalSeconds = totalSeconds - hour*(60*60)
            duration += `${hour} hours `
        }
        if(totalSeconds>=60){
            let munite = parseInt(totalSeconds/(60))
            totalSeconds = totalSeconds - munite*(60)
            duration += `${munite} munites `
        }

        if(totalSeconds != 0) duration += `${totalSeconds} seconds`
        
        return duration
    },
    convertStringDurationToSeconds(strDuration){
      // Input Type
      // '17 days 2 hours 47 munites 44 seconds'

      let timeNumbers = strDuration.split(' ').filter(item => item == parseInt(item)).map(Number)
      let timeString = strDuration.split(' ').filter(item => item != parseInt(item))
      let seconds = 0
      timeString.forEach((item, index) => {
          if(item == 'years') seconds += timeNumbers[index]*365*24*60*60
          else if(item == 'days') seconds += timeNumbers[index]*24*60*60
          else if(item == 'hours') seconds += timeNumbers[index]*60*60
          else if(item == 'munites') seconds += timeNumbers[index]*60
          else if(item == 'seconds') seconds += timeNumbers[index]
      })
      return seconds
    },
    calculateDurationInSecond(startTime, endTime){
      // Input Type 
      // 2022-10-12 11:27:56 AM    2022-09-25 11:48:20 AM
      return moment.duration(moment(startTime).diff(moment(endTime))).asSeconds()
    },
    log(event, stage) {
      if(event["added"] !== undefined) this.stateChanged.push({added:  event.added, stage: stage})
      else this.stateChanged.push({removed:  event.removed, stage: stage})
    },
  }
}
</script>
<style scoped lang="scss">
.div-container{
  width: 250px;
  min-height: 470px;
  margin: 10px; 
}
</style>